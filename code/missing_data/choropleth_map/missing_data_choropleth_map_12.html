<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Population Density by Region</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        #chart {
            width: 1000px;
            height: 750px;
            margin: 60px auto;
        }
        path {
            stroke: #fff;
        }
        .legend {
            font-size: 12px;
        }
        .region-label {
            font-size: 24px;
            fill: black;
            font-weight: bold;
        }
        .missing-data {
            fill: url(#missingPattern);
        }
        #missing-pattern {
            fill: #f00;
            fill-opacity: 0.5;
        }
    </style>
</head>
<body>
    <h1>Population Density by Region (per km²)</h1>
    <div id="chart">
        <svg width="1000" height="750"></svg>
    </div>

    <script>
        const width = 1000, height = 750;
        const svg = d3.select("svg");

        const projection = d3.geoNaturalEarth1()
            .scale(220)
            .translate([width / 2.5, height / 2]);

        const path = d3.geoPath().projection(projection);

        const defs = svg.append("defs");

        const pattern = defs.append("pattern")
            .attr("id", "missingPattern")
            .attr("width", 6)
            .attr("height", 6)
            .attr("patternUnits", "userSpaceOnUse");
        
        pattern.append("rect")
            .attr("width", 6)
            .attr("height", 6)
            .attr("id", "missing-pattern")
            .style("fill", "none");

        pattern.append("path")
            .attr("d", "M0,0L6,6 M6,0L0,6")
            .attr("stroke", "#f00")
            .attr("stroke-width", 1);

        d3.json("https://d3js.org/world-110m.v1.json").then(world => {
            d3.csv("../../../../data/missing_data/choropleth_map/missing_data_choropleth_map_12.csv").then(data => {
                const countries = topojson.feature(world, world.objects.countries).features;

                const colorScale = d3.scaleThreshold()
                    .domain([1, 10, 50, 100])
                    .range(["#f7fcb9", "#addd8e", "#31a354", "#006837"]);

                const densityById = {};
                const labels = {};
                data.forEach(d => {
                    densityById[d.id] = +d.population_density;
                    labels[d.id] = d.region;
                });

                svg.selectAll("path")
                    .data(countries)
                    .join("path")
                    .attr("d", path)
                    .attr("fill", d => {
                        const density = densityById[d.id];
                        // Missing data regions (density = 0 or undefined)
                        if (density === 0 || density === undefined) {
                            return "#ccc";
                        }
                        return colorScale(density);
                    });

                // Only show labels for key regions (A, B, C, D, E)
                svg.selectAll(".region-label")
                    .data(data.filter(d => ['R-A', 'R-B', 'R-C', 'R-D', 'R-E'].includes(d.code)))
                    .join("text")
                    .attr("class", "region-label")
                    .attr("x", d => {
                        const coords = projection([d.longitude, d.latitude]);
                        return coords ? coords[0] : -10;
                    })
                    .attr("y", d => {
                        const coords = projection([d.longitude, d.latitude]);
                        return coords ? coords[1] : -10;
                    })
                    .text(d => d.code.replace('R-', ''));



                // Create proper threshold legend (place between Australia and Antarctica)
                const legendWidth = 300;
                const legendHeight = 20;
                const legendX = 500;
                const legendY = 550;

                // Create legend rectangles
                const legendData = [
                    { color: "#f7fcb9", label: "1-10" },
                    { color: "#addd8e", label: "10-50" },
                    { color: "#31a354", label: "50-100" },
                    { color: "#006837", label: "100+" },
                    { color: "#ccc", label: "No data" }
                ];

                svg.selectAll(".legend-rect")
                    .data(legendData)
                    .join("rect")
                    .attr("class", "legend-rect")
                    .attr("x", (d, i) => legendX + i * (legendWidth / 5))
                    .attr("y", legendY)
                    .attr("width", legendWidth / 5 - 2)
                    .attr("height", legendHeight)
                    .attr("fill", d => d.color)
                    .attr("stroke", "#000");

                // Add legend labels
                svg.selectAll(".legend-label")
                    .data(legendData)
                    .join("text")
                    .attr("class", "legend-label")
                    .attr("x", (d, i) => legendX + i * (legendWidth / 5) + (legendWidth / 5) / 2)
                    .attr("y", legendY + legendHeight + 15)
                    .attr("text-anchor", "middle")
                    .style("font-size", "10px")
                    .text(d => d.label);

                // Add legend title
                svg.append("text")
                    .attr("x", legendX + legendWidth / 2)
                    .attr("y", legendY - 10)
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("font-weight", "bold")
                    .text("Population Density (per km²)");
            });
        });
    </script>
</body>
</html>
